<script>

    document.getElementById("indispo").addEventListener("change", switchIndispoDate);
    document.getElementById("updateProfil").addEventListener("click", update);

    document.addEventListener('DOMContentLoaded', function () {
        var selectBoxes = document.querySelectorAll('select');
        M.FormSelect.init(selectBoxes);
        var datePicker = document.getElementById('indispoDate');
        M.Datepicker.init(datePicker, {
            autoClose: true,
            minDate: new Date(Date.now()),
            format: 'dd/mm/yyyy'
        });
    });


    function update() {
        var toValidate = {
            prenom: "Le prenom doit être rempli",
            nom: "Le nom doit être rempli",
            site: "Le site doit être choisi",
            poste: "Le poste doit être choisi",
            dribble: "Le niveau de dribble doit être rempli",
            frappe: "Le niveau de frappe doit être rempli",
            defense: "Le niveau de défense doit être rempli"
        };

        var idKeys = Object.keys(toValidate);

        var allValid = true;
        idKeys.forEach(function (k) {
            if (!checkValidity(k, toValidate[k])) {
                allValid = false;
            }
        });

        if (allValid) {
            updateProfil();
        }
    }

    function checkValidity(elementId, message) {
        var isValid = document.getElementById(elementId).checkValidity();
        if (!isValid) {
            M.toast({ html: message });
            return false;
        }
        return true;
    }

    function updateProfil() {
        var user = {};
        user.mail = document.getElementById("mail").value;
        user.key = document.getElementById("key").value;
        user.prenom = document.getElementById("prenom").value;
        user.nom = document.getElementById("nom").value;
        user.surnom = document.getElementById("surnom").value;
        user.indispo = document.getElementById("indispo").checked;
        user.indispoDate = document.getElementById("indispoDate").value;
        user.lundi = document.getElementById("lundi").checked;
        user.mardi = document.getElementById("mardi").checked;
        user.mercredi = document.getElementById("mercredi").checked;
        user.jeudi = document.getElementById("jeudi").checked;
        user.vendredi = document.getElementById("vendredi").checked;
        user.site = document.getElementById("site").value;
        user.poste = document.getElementById("poste").value;
        user.dribble = document.querySelector('input[name="dribble"]:checked').value;
        user.frappe = document.querySelector('input[name="frappe"]:checked').value;
        user.defense = document.querySelector('input[name="defense"]:checked').value;

        console.log(user);
        M.toast({html: "En cours de modification"});
        google.script.run.withSuccessHandler(updateProfilSuccess).withFailureHandler(updateProfilFailure).updateProfil(user);

    }

    function updateProfilSuccess() {
        M.toast({html: "Profil modifié"});
    }

    function updateProfilFailure() {
        M.toast({html: "Clef non valide"});
    }

    function switchIndispoDate() {
        if (document.getElementById("indispo").checked) {
            document.getElementById('indispoDate').removeAttribute("disabled");
            M.Datepicker.getInstance(document.getElementById('indispoDate')).open();
            M.toast({
                html: "Sélectionne ta date de fin d'insponibilité"
            })
        } else {
            document.getElementById('indispoDate').value = "";
            document.getElementById('indispoDate').setAttribute("disabled", "disabled");
        }
    }

</script>