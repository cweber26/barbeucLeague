<script>

    document.getElementById("indispo").addEventListener("change", switchIndispoDate);

    document.addEventListener('DOMContentLoaded', function () {
        var selectBoxes = document.querySelectorAll('select');
        M.FormSelect.init(selectBoxes);
        var datePicker = document.getElementById('indispoDate');
        M.Datepicker.init(datePicker, {
            autoClose: true,
            format: 'dd/mm/yyyy'
        });
    });

    document.addEventListener('keypress', function (ev) {
        if(ev.keyCode === 13) {
            if(document.getElementById("updateProfil")) {
                document.getElementById("updateProfil").click();
            } else if (document.getElementById("createProfil")) {
                document.getElementById("createProfil").click();
            }
        }
    });

    function updateProfilCheck() {
        if(profilInfosAreOk()){
            updateProfil();
        }
    }

    function createProfilCheck() {
        if(profilInfosAreOk()){
            createProfil();
        }
    }

    function profilInfosAreOk() {
        var toValidate = {
            mail: "Le mail doit être rempli",
            prenom: "Le prenom doit être rempli",
            nom: "Le nom doit être rempli",
            surnom: "Le surnom doit être rempli",
            site: "Le site doit être choisi",
            poste: "Le poste doit être choisi",
            dribble: "Le niveau de dribble doit être rempli",
            frappe: "Le niveau de frappe doit être rempli",
            defense: "Le niveau de défense doit être rempli"
        };

        Object.keys(toValidate).forEach(function (k) {
            if (!checkValidity(k, toValidate[k])) {
                console.log("data missing to create/update a profil");
                return false;
            }
        });

        return validateNotEmpty() && validateEmailFormat();
    }

    function checkValidity(elementId, message) {
        var isValid = document.getElementById(elementId).checkValidity();
        if (!isValid) {
            M.toast({html: message});
            return false;
        }
        return true;
    }

    function validateNotEmpty() {
        return document.getElementById("mail").value.trim() != "" && document.getElementById("prenom").value.trim() != "" && document.getElementById("nom").value.trim() != "";
    }

    function validateEmailFormat() {
        var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        if(!re.test(String(document.getElementById("mail").value).toLowerCase())){
            M.toast({html: "Le format de l'adresse mail n'est pas correct"});
            return false;
        }
        return true;
    }

    function updateProfil() {
        var user = {};
        user.mail = document.getElementById("mail").value.trim();
        user.oldMail = document.getElementById("oldMail").value;
        user.key = document.getElementById("key").value;
        user.prenom = document.getElementById("prenom").value.trim();
        user.nom = document.getElementById("nom").value.trim();
        user.surnom = document.getElementById("surnom").value.trim();
        user.indispo = document.getElementById("indispo").checked;
        user.indispoDate = document.getElementById("indispoDate").value;
        user.lundi = document.getElementById("lundi").checked;
        user.mardi = document.getElementById("mardi").checked;
        user.mercredi = document.getElementById("mercredi").checked;
        user.jeudi = document.getElementById("jeudi").checked;
        user.vendredi = document.getElementById("vendredi").checked;
        user.site = document.getElementById("site").value;
        user.poste = document.getElementById("poste").value;
        user.dribble = document.querySelector('input[name="dribble"]:checked').value;
        user.frappe = document.querySelector('input[name="frappe"]:checked').value;
        user.defense = document.querySelector('input[name="defense"]:checked').value;
        if (document.getElementById("priorityLevel")) {
            user.priorityLevel = document.getElementById("priorityLevel").value;
        }
        if (document.getElementById("isAnAdmin")) {
            user.isAnAdmin = document.getElementById("isAnAdmin").checked;
        }
        if (document.getElementById("haveAPriority")) {
            user.haveAPriority = document.getElementById("haveAPriority").checked;
        }

        console.log(user);
        M.toast({html: "En cours de modification"});
        google.script.run.withSuccessHandler(updateProfilSuccess).withFailureHandler(updateProfilFailure).updateProfil(user);

    }



    function updateProfilSuccess(newParameter) {
        google.script.run.withSuccessHandler(updateProfilSuccessWithUrl).getUrl();
        function updateProfilSuccessWithUrl(url) {
            google.script.url.getLocation(function (location) {
                console.log(location.parameter);
                if (location.parameter.profilMail) {
                    if(newParameter){
                        location.parameter.profilMail = newParameter.mail;
                        window.top.location.href = url+"?page=profil&mail=" + String(location.parameter.mail) + "&key=" + String(location.parameter.key) + "&profilMail=" + String(location.parameter.profilMail);
                    }
                } else if (newParameter) {
                    location.parameter.mail = newParameter.mail;
                    location.parameter.key = newParameter.key;
                    window.top.location.href = url+"?page=profil&mail=" + String(location.parameter.mail) + "&key=" + String(location.parameter.key);
                } else {
                    M.toast({html: "Profil modifié"});
                }
            });
        }
    }

    function updateProfilFailure() {
        M.toast({html: "Clef non valide"});
    }

    function createProfil() {
        var user = {};
        user.mail = document.getElementById("mail").value.trim();
        user.prenom = document.getElementById("prenom").value.trim();
        user.nom = document.getElementById("nom").value.trim();
        user.surnom = document.getElementById("surnom").value.trim();
        user.indispo = document.getElementById("indispo").checked;
        user.indispoDate = document.getElementById("indispoDate").value;
        user.lundi = document.getElementById("lundi").checked;
        user.mardi = document.getElementById("mardi").checked;
        user.mercredi = document.getElementById("mercredi").checked;
        user.jeudi = document.getElementById("jeudi").checked;
        user.vendredi = document.getElementById("vendredi").checked;
        user.site = document.getElementById("site").value;
        user.poste = document.getElementById("poste").value;
        user.dribble = document.querySelector('input[name="dribble"]:checked').value;
        user.frappe = document.querySelector('input[name="frappe"]:checked').value;
        user.defense = document.querySelector('input[name="defense"]:checked').value;
        if (document.getElementById("priorityLevel")) {
            user.priorityLevel = document.getElementById("priorityLevel").value;
        }
        if (document.getElementById("isAnAdmin")) {
            user.isAnAdmin = document.getElementById("isAnAdmin").checked;
        }
        if (document.getElementById("haveAPriority")) {
            user.haveAPriority = document.getElementById("haveAPriority").checked;
        }

        console.log(user);
        M.toast({html: "En cours de création"});
        google.script.url.getLocation(function (location) {
            var parameter = location.parameter;
            google.script.run.withSuccessHandler(createProfilSuccess).withFailureHandler(createProfilFailure).createProfil(user, parameter.mail);
        });

    }

    function createProfilSuccess(message) {
        if(message) {
            M.toast({html: message});
        } else {
            M.toast({html: "Profil créé : l'utilisateur recevra les mails selon le type de convocation choisi", displayLength: 10000});
        }
    }

    function createProfilFailure() {
        if(message) {
            M.toast({html: message});
        } else {
            M.toast({html: "Création du profil en erreur"});
        }
    }

    function switchIndispoDate() {
        if (document.getElementById("indispo").checked) {
            document.getElementById('indispoDate').removeAttribute("disabled");
            M.Datepicker.getInstance(document.getElementById('indispoDate')).open();
            M.toast({
                html: "Sélectionne ta date de fin d'insponibilité"
            })
        } else {
            document.getElementById('indispoDate').value = "";
            document.getElementById('indispoDate').setAttribute("disabled", "disabled");
        }
    }

    function archiveProfilJs() {
        google.script.run.withSuccessHandler(archiveProfilJsWithUrl).getUrl();
        function archiveProfilJsWithUrl(url) {
            M.toast({html: "Suppression en cours"});
            var mail = document.getElementById("mail").value;
            google.script.run.archiveProfil(mail);
            window.top.location.href = url+"?page=profilArchived";
        }
    }

</script>