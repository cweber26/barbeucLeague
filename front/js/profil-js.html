<script>

    document.getElementById("indispo").addEventListener("change", switchIndispoDate);

    document.addEventListener('DOMContentLoaded', function () {
        var selectBoxes = document.querySelectorAll('select');
        M.FormSelect.init(selectBoxes);
        var datePicker = document.getElementById('indispoDate');
        M.Datepicker.init(datePicker, {
            autoClose: true,
            format: 'dd/mm/yyyy'
        });
    });

    document.addEventListener('keypress', function (ev) {
        if(ev.keyCode === 13) {
            if(document.getElementById("updateProfil")) {
                document.getElementById("updateProfil").click();
            } else if (document.getElementById("createProfil")) {
                document.getElementById("createProfil").click();
            }
        }
    });

    function updateProfilCheck() {
        if(profilInfosAreOk()){
            updateProfil();
        }
    }

    function createProfilCheck() {
        if(profilInfosAreOk()){
            createProfil();
        }
    }

    function profilInfosAreOk() {
        var toValidate = {
            mail: "Le mail doit être rempli",
            prenom: "Le prenom doit être rempli",
            nom: "Le nom doit être rempli",
            surnom: "Le surnom doit être rempli",
            site: "Le site doit être choisi",
            poste: "Le poste doit être choisi",
            dribble: "Le niveau de dribble doit être rempli",
            frappe: "Le niveau de frappe doit être rempli",
            defense: "Le niveau de défense doit être rempli"
        };

        Object.keys(toValidate).forEach(function (k) {
            if (!checkValidity(k, toValidate[k])) {
                return false;
            }
        });
        return true;
    }

    function checkValidity(elementId, message) {
        var isValid = document.getElementById(elementId).checkValidity();
        if (!isValid) {
            M.toast({html: message});
            return false;
        }
        return true;
    }

    function updateProfil() {
        var user = {};
        user.mail = document.getElementById("mail").value;
        user.oldMail = document.getElementById("oldMail").value;
        user.key = document.getElementById("key").value;
        user.prenom = document.getElementById("prenom").value;
        user.nom = document.getElementById("nom").value;
        user.surnom = document.getElementById("surnom").value;
        user.indispo = document.getElementById("indispo").checked;
        user.indispoDate = document.getElementById("indispoDate").value;
        user.lundi = document.getElementById("lundi").checked;
        user.mardi = document.getElementById("mardi").checked;
        user.mercredi = document.getElementById("mercredi").checked;
        user.jeudi = document.getElementById("jeudi").checked;
        user.vendredi = document.getElementById("vendredi").checked;
        user.site = document.getElementById("site").value;
        user.poste = document.getElementById("poste").value;
        user.dribble = document.querySelector('input[name="dribble"]:checked').value;
        user.frappe = document.querySelector('input[name="frappe"]:checked').value;
        user.defense = document.querySelector('input[name="defense"]:checked').value;
        if (document.getElementById("priorityLevel")) {
            user.priorityLevel = document.getElementById("priorityLevel").value;
        }
        if (document.getElementById("isAnAdmin")) {
            user.isAnAdmin = document.getElementById("isAnAdmin").checked;
        }
        if (document.getElementById("haveAPriority")) {
            user.haveAPriority = document.getElementById("haveAPriority").checked;
        }

        console.log(user);
        M.toast({html: "En cours de modification"});
        google.script.run.withSuccessHandler(updateProfilSuccess).withFailureHandler(updateProfilFailure).updateProfil(user);

    }

    function updateProfilSuccess(newParameter) {
        google.script.url.getLocation(function (location) {
            var parameter = location.parameter;
            console.log(parameter);
            if (parameter.profilMail) {
                if(newParameter){
                    parameter.profilMail = newParameter.mail;
                    window.top.location.href = "https://script.google.com/macros/s/AKfycbw7SggSd_5zNsbmfZ3nUU_nr2cXfRYIgntGSLh2n3sNhOJyUDs/exec?page=profil&mail=" + String(parameter.mail) + "&key=" + String(parameter.key) + "&profilMail=" + String(parameter.profilMail);
                }
            } else if (newParameter) {
                parameter.mail = newParameter.mail;
                parameter.key = newParameter.key;
                window.top.location.href = "https://script.google.com/macros/s/AKfycbw7SggSd_5zNsbmfZ3nUU_nr2cXfRYIgntGSLh2n3sNhOJyUDs/exec?page=profil&mail=" + String(parameter.mail) + "&key=" + String(parameter.key);
            } else {
                M.toast({html: "Profil modifié"});
            }
        });
    }

    function updateProfilFailure() {
        M.toast({html: "Clef non valide"});
    }

    function createProfil() {
        var user = {};
        user.mail = document.getElementById("mail").value;
        user.prenom = document.getElementById("prenom").value;
        user.nom = document.getElementById("nom").value;
        user.surnom = document.getElementById("surnom").value;
        user.indispo = document.getElementById("indispo").checked;
        user.indispoDate = document.getElementById("indispoDate").value;
        user.lundi = document.getElementById("lundi").checked;
        user.mardi = document.getElementById("mardi").checked;
        user.mercredi = document.getElementById("mercredi").checked;
        user.jeudi = document.getElementById("jeudi").checked;
        user.vendredi = document.getElementById("vendredi").checked;
        user.site = document.getElementById("site").value;
        user.poste = document.getElementById("poste").value;
        user.dribble = document.querySelector('input[name="dribble"]:checked').value;
        user.frappe = document.querySelector('input[name="frappe"]:checked').value;
        user.defense = document.querySelector('input[name="defense"]:checked').value;
        if (document.getElementById("priorityLevel")) {
            user.priorityLevel = document.getElementById("priorityLevel").value;
        }
        if (document.getElementById("isAnAdmin")) {
            user.isAnAdmin = document.getElementById("isAnAdmin").checked;
        }
        if (document.getElementById("haveAPriority")) {
            user.haveAPriority = document.getElementById("haveAPriority").checked;
        }

        console.log(user);
        M.toast({html: "En cours de création"});
        google.script.url.getLocation(function (location) {
            var parameter = location.parameter;
            google.script.run.withSuccessHandler(createProfilSuccess).withFailureHandler(createProfilFailure).createProfil(user, parameter.mail);
        });

    }

    function createProfilSuccess(message) {
        if(message) {
            M.toast({html: message});
        } else {
            M.toast({html: "Profil créé : l'utilisateur recevra les mails selon le type de convation choisi", displayLength: 10000});
        }
    }

    function createProfilFailure() {
        if(message) {
            M.toast({html: message});
        } else {
            M.toast({html: "Création du profil en erreur"});
        }
    }

    function switchIndispoDate() {
        if (document.getElementById("indispo").checked) {
            document.getElementById('indispoDate').removeAttribute("disabled");
            M.Datepicker.getInstance(document.getElementById('indispoDate')).open();
            M.toast({
                html: "Sélectionne ta date de fin d'insponibilité"
            })
        } else {
            document.getElementById('indispoDate').value = "";
            document.getElementById('indispoDate').setAttribute("disabled", "disabled");
        }
    }

    function archiveProfilJs() {
        if (window.confirm("Es tu sûr de vouloir supprimer ?")) {
            var mail = document.getElementById("mail").value;
            google.script.run.archiveProfil(mail);
            window.top.location.href = "https://script.google.com/macros/s/AKfycbw7SggSd_5zNsbmfZ3nUU_nr2cXfRYIgntGSLh2n3sNhOJyUDs/exec?page=deletion";
        }
    }

</script>